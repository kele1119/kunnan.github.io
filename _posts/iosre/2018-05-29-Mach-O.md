---
layout: post
title: Mach-O
date: 2018-05-29
tag: iosre
site: https://zhangkn.github.io
catalog: true
author: kunnan
subtitle: mach-o文件解析
---

# Mach-O 

>* Apple 系统上（包括 MacOS 以及 iOS）的可执行文件格式

```
<!-- Mach-O 是 Mach object 文件格式的缩写 -->
1、这种文件格式由文件头（Header）、加载命令（Load Commands）以及具体数据（Segment&Section）三部分组成

2、一种用于记录可执行文件、对象代码、共享库、动态加载代码和内存转储的文件格式。作为 a.out 格式的替代品，Mach-O 提供了更好的扩展性，并提升了符号表中信息的访问速度。

```

# 分析 Mach-O

#### [Mach-O & Universal Binary Parser](https://github.com/aaronst/macholibre)

>* macholibre: 一个解析macho 文件信息的工具，输出的是json   

```sh
devzkndeMacBook-Pro:~ devzkn$  pyenv global 3.7.0b2
devzkndeMacBook-Pro:~ devzkn$ pyenv global
3.7.0b2
devzkndeMacBook-Pro:~ devzkn$ pip3 install git+https://github.com/aaronst/macholibre.git
```
>* ` /Users/devzkn/.pyenv/shims/macholibre  -o output.json ~/tmp`

```
devzkndeMacBook-Pro:~ devzkn$ which macholibre
/Users/devzkn/.pyenv/shims/macholibre
devzkndeMacBook-Pro:~ devzkn$ ls -lrt /Users/devzkn/.pyenv/shims/
```

#### [遍历cmd中segment和section](https://github.com/kunnan/KNCheck_and_Modify_machO_symbol)


```
因为 objc_msgSend 特殊原因, 要混淆 __TEXT.__objc_methname 才算是真正的混淆
```

#### MachOView.app

>* [MachOView.app](https://github.com/iOSobfuscation/IOSCodes/tree/master/MachOView.app/Contents)
>* [gdbinit/MachOView](https://github.com/gdbinit/MachOView)
>* [MachOExplorer](https://github.com/everettjf/MachOExplorer)
>


#  xcrun


>* 查看section段: 有些 segment 中有多个 section ` xcrun size -x -l -m tmp`



>* ` xcrun otool -v -s __TEXT __cstring tmp`
>

```
__cstring 包含了可执行文件中的字符串常量 – 在源码中被双引号包含的字符串- 方法名

```


#### 在 segment中，一般都会有多个 section


######  1、在 `__TEXT segment `中，`__text section` 包含了编译所得到的机器码。
>*  `__stubs` 和 `__stub_helper `是给动态链接器 (dyld) 使用的。通过这两个 section，在动态链接代码中，可以允许延迟链接。

>* `__const `是常量，不可变的，就像 `__cstring` (包含了可执行文件中的字符串常量 – 在源码中被双引号包含的字符串) 常量一样。

###### 2、__DATA segment 中包含了可读写数据

>* `__nl_symbol_ptr` 和` __la_symbol_ptr`，它们分别是 non-lazy 和 lazy 符号指针

>* ` __const`，在这里面会包含一些需要重定向的常量数据

>* ` __bss section `没有被初始化的静态变量



# 除了`hopper`  ，还有一个工具很强大`otool`


#### 查看某段中某的节

>* `otool -t tmp`
```sh
tmp (architecture armv7):
Contents of (__TEXT,__text) section
```

>*  查看某段中某的节: `otool -s __TEXT __text tmp ` 
```sh
tmp (architecture armv7):
Contents of (__TEXT,__text) section
```

由此可以看出 -t 参数在otool 中是 -s __TEXT __tex的简写


>* `xcrun otool -v -s __TEXT __const tmp`
>* ` xcrun otool -v -s __TEXT __cstring tmp`

```
包含了可执行文件中的字符串常量 – 在源码中被双引号包含的字符串- 方法名
```


#### 使用otool 查看反汇编代码 -tv

>* `otool -tv tmp`


# See Also 
>* [gdbinit/MachOView](https://github.com/gdbinit/MachOView)
>* [A library that enables dynamically rebinding symbols in Mach-O binaries running on iOS.](https://github.com/facebook/fishhook)

>* [everettjf.com](https://everettjf.com/2018/01/15/ios-app-reverse-engineering-stuff/)
>
>* [scan iOS private api](https://github.com/mrmign/iOS-private-api-scanner)
>* [iOS-private-api-checker](https://github.com/NetEaseGame/iOS-private-api-checker)
>* [Mach-O](http://www.starming.com/2017/03/01/deeply-analyse-llvm/#Mach-O-%E6%96%87%E4%BB%B6)
>* [A reverse engineering tool to restore stripped symbol table for iOS app.](http://blog.imjun.net/posts/restore-symbol-of-iOS-app/)

```
https://github.com/tobefuturer/restore-symbol
```
>* [MachO文件的符号混淆](http://iosre.com/t/macho/3786/11)

>* [knpost](https://github.com/zhangkn/KNBin/blob/master/knpost) 
>
```
/Users/devzkn/bin/knpost Mach-O mach-o文件解析 -t iosre
> #原来""的参数，需要自己加上""
```

